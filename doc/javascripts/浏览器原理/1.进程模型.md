# 浏览器进程模型

## 目录

- [1. 浏览器架构演进](#1-浏览器架构演进)
- [2. Chrome 多进程架构](#2-chrome-多进程架构)
  - [2.1 浏览器主进程 (Browser Process)](#21-浏览器主进程-browser-process)
  - [2.2 渲染进程 (Renderer Process)](#22-渲染进程-renderer-process)
  - [2.3 GPU 进程 (GPU Process)](#23-gpu-进程-gpu-process)
  - [2.4 网络进程 (Network Process)](#24-网络进程-network-process)
  - [2.5 插件进程 (Plugin Process)](#25-插件进程-plugin-process)
  - [2.6 实用程序进程 (Utility Process)](#26-实用程序进程-utility-process)
- [3. 渲染进程中的线程](#3-渲染进程中的线程)
  - [3.1 主线程 (Main Thread)](#31-主线程-main-thread)
  - [3.2 合成线程 (Compositor Thread)](#32-合成线程-compositor-thread)
  - [3.3 光栅化线程 (Raster Thread)](#33-光栅化线程-raster-thread)
  - [3.4 Worker 线程](#34-worker-线程)
- [4. 站点隔离 (Site Isolation)](#4-站点隔离-site-isolation)
- [5. 进程间通信 (IPC)](#5-进程间通信-ipc)
- [6. 从输入 URL 到页面展示](#6-从输入-url-到页面展示)
- [7. 查看 Chrome 进程](#7-查看-chrome-进程)

---

## 1. 浏览器架构演进

### 单进程架构（早期浏览器）

```
┌─────────────────────────────────────────┐
│              单进程浏览器                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐   │
│  │  网络   │ │  渲染   │ │  插件   │   │
│  └─────────┘ └─────────┘ └─────────┘   │
│  ┌─────────┐ ┌─────────┐               │
│  │   JS    │ │   UI    │               │
│  └─────────┘ └─────────┘               │
└─────────────────────────────────────────┘
```

**问题：**
- 不稳定：一个模块崩溃导致整个浏览器崩溃
- 不安全：插件和页面可以获取浏览器所有权限
- 不流畅：所有任务在一个线程执行，容易卡顿

### 多进程架构（现代浏览器）

```
┌──────────────────────────────────────────────────────────────┐
│                     Chrome 多进程架构                         │
│                                                              │
│  ┌────────────────┐                                          │
│  │  浏览器主进程   │  ← 负责界面、用户交互、子进程管理          │
│  └───────┬────────┘                                          │
│          │                                                   │
│  ┌───────┴───────┬──────────────┬──────────────┐            │
│  │               │              │              │            │
│  ▼               ▼              ▼              ▼            │
│ ┌────┐  ┌────────────┐  ┌────────────┐  ┌──────────┐       │
│ │GPU │  │ 渲染进程 1  │  │ 渲染进程 2  │  │ 网络进程 │       │
│ │进程│  │  (Tab 1)   │  │  (Tab 2)   │  │          │       │
│ └────┘  └────────────┘  └────────────┘  └──────────┘       │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**优势：**
- 稳定性：进程隔离，一个标签页崩溃不影响其他
- 安全性：沙箱机制，限制渲染进程权限
- 流畅性：多进程并行处理

## 2. Chrome 多进程架构

### 2.1 浏览器主进程 (Browser Process)

**职责：**
- 界面显示（地址栏、书签、前进后退按钮）
- 用户交互处理
- 子进程管理和协调
- 文件存储（书签、历史记录、Cookie）

```javascript
// 浏览器主进程的主要模块
const BrowserProcess = {
  // UI 线程：处理用户输入、绘制浏览器界面
  UIThread: {
    handleAddressBarInput() {},
    drawBrowserUI() {},
    manageBookmarks() {},
  },
  
  // 网络线程：处理网络请求（已移至独立进程）
  // NetworkThread: { ... }
  
  // 存储线程：处理文件访问
  StorageThread: {
    saveBookmarks() {},
    readHistory() {},
    manageCookies() {},
  },
};
```

### 2.2 渲染进程 (Renderer Process)

**职责：**
- HTML、CSS 解析
- JavaScript 执行
- 页面渲染
- 事件处理

```javascript
// 渲染进程的核心组件
const RendererProcess = {
  // Blink 渲染引擎
  Blink: {
    parseHTML() {},      // HTML 解析
    parseCSS() {},       // CSS 解析
    buildDOMTree() {},   // 构建 DOM 树
    buildCSSOMTree() {}, // 构建 CSSOM 树
    layout() {},         // 布局计算
    paint() {},          // 绘制
  },
  
  // V8 JavaScript 引擎
  V8: {
    parse() {},          // 解析 JS
    compile() {},        // 编译
    execute() {},        // 执行
    garbageCollect() {}, // 垃圾回收
  },
};
```

**进程分配策略：**

```javascript
// Chrome 的进程模型策略
const ProcessModels = {
  // 每个站点一个进程（默认）
  'process-per-site-instance': '同一站点的不同标签页共享进程',
  
  // 每个标签页一个进程
  'process-per-tab': '每个标签页独立进程',
  
  // 单进程模式（调试用）
  'single-process': '所有内容在一个进程',
};

// 站点定义：协议 + 根域名
// https://www.example.com 和 https://api.example.com 是同一站点
// https://example.com 和 https://other.com 是不同站点
```

### 2.3 GPU 进程 (GPU Process)

**职责：**
- 处理所有 GPU 任务
- 3D CSS 效果
- 绑定 WebGL
- 视频解码
- 页面合成

```javascript
// GPU 进程处理的任务
const GPUProcess = {
  // 页面合成
  composite() {
    // 将多个图层合成为最终图像
  },
  
  // 3D 变换
  handle3DTransform() {
    // transform: rotate3d(), translate3d()
  },
  
  // WebGL 渲染
  handleWebGL() {
    // WebGL 上下文和绑定调用
  },
  
  // 视频解码
  decodeVideo() {
    // 硬件加速视频解码
  },
};
```

### 2.4 网络进程 (Network Process)

**职责：**
- 处理所有网络请求
- 资源加载
- 缓存管理

```javascript
// 网络进程的工作流程
const NetworkProcess = {
  async fetchResource(url) {
    // 1. 检查缓存
    const cached = await this.checkCache(url);
    if (cached && !cached.expired) {
      return cached.data;
    }
    
    // 2. DNS 解析
    const ip = await this.dnsResolve(url);
    
    // 3. 建立连接（TCP/TLS）
    const connection = await this.connect(ip);
    
    // 4. 发送请求
    const response = await this.sendRequest(connection, url);
    
    // 5. 处理响应
    return this.processResponse(response);
  },
  
  checkCache(url) { /* 强缓存、协商缓存 */ },
  dnsResolve(url) { /* DNS 查询 */ },
  connect(ip) { /* TCP 三次握手、TLS 握手 */ },
};
```

### 2.5 插件进程 (Plugin Process)

**职责：**
- 运行浏览器插件（如 Flash，已废弃）
- 每种类型的插件一个进程

```javascript
// 插件进程（主要是历史遗留）
const PluginProcess = {
  // 现代浏览器主要使用扩展（Extension）而非插件
  // 扩展运行在独立的渲染进程中
};
```

### 2.6 实用程序进程 (Utility Process)

**职责：**
- 音频服务
- 数据解码
- 其他实用功能

```javascript
// 实用程序进程示例
const UtilityProcess = {
  AudioService: {
    playAudio() {},
    processAudio() {},
  },
  
  DataDecoder: {
    decodeImage() {},
    decodeJSON() {},
  },
};
```

## 3. 渲染进程中的线程

```
┌─────────────────────────────────────────────────────────────┐
│                       渲染进程                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    主线程                            │   │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐     │   │
│  │  │ HTML │→│ CSS  │→│ 布局 │→│ 绘制 │→│  JS  │     │   │
│  │  │ 解析 │ │ 解析 │ │      │ │      │ │ 执行 │     │   │
│  │  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘     │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   合成线程                           │   │
│  │           分层 → 分块 → 光栅化调度 → 合成            │   │
│  └─────────────────────────────────────────────────────┘   │
│                            │                                │
│                            ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              光栅化线程池（多个线程）                  │   │
│  │     ┌────┐  ┌────┐  ┌────┐  ┌────┐                 │   │
│  │     │ R1 │  │ R2 │  │ R3 │  │ R4 │                 │   │
│  │     └────┘  └────┘  └────┘  └────┘                 │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  Worker 线程                         │   │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐    │   │
│  │  │ Web Worker │  │  Service   │  │   Shared   │    │   │
│  │  │            │  │  Worker    │  │   Worker   │    │   │
│  │  └────────────┘  └────────────┘  └────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.1 主线程 (Main Thread)

**职责：**
- 解析 HTML/CSS
- 执行 JavaScript
- 计算样式和布局
- 绑制记录生成

```javascript
// 主线程的工作内容
const MainThread = {
  // 1. 解析 HTML，构建 DOM
  parseHTML(html) {
    // 字节 → 字符 → Token → Node → DOM Tree
  },
  
  // 2. 解析 CSS，构建 CSSOM
  parseCSS(css) {
    // 字节 → 字符 → Token → Node → CSSOM Tree
  },
  
  // 3. 合并生成渲染树
  buildRenderTree(dom, cssom) {
    // DOM + CSSOM = Render Tree
    // 注意：display: none 的元素不在渲染树中
  },
  
  // 4. 布局（Layout/Reflow）
  layout(renderTree) {
    // 计算每个节点的几何信息（位置、大小）
  },
  
  // 5. 绑制（Paint）
  paint(layoutTree) {
    // 生成绑制记录（Paint Records）
  },
  
  // 6. 执行 JavaScript
  executeJS(script) {
    // V8 引擎执行
    // 注意：JS 执行会阻塞渲染
  },
};
```

### 3.2 合成线程 (Compositor Thread)

**职责：**
- 图层分割
- 图块分割
- 调度光栅化
- 合成帧

```javascript
// 合成线程的工作
const CompositorThread = {
  // 1. 分层（Layer）
  createLayers(paintRecords) {
    // 根据层叠上下文、transform、opacity 等创建图层
    // 某些 CSS 属性会创建新的合成层：
    // - transform: translate3d(), scale3d()
    // - opacity 动画
    // - will-change
    // - video, canvas, iframe
  },
  
  // 2. 分块（Tile）
  splitIntoTiles(layer) {
    // 将图层分割成小块（通常 256x256 或 512x512）
    // 优先处理视口内的图块
  },
  
  // 3. 调度光栅化
  scheduleRasterization(tiles) {
    // 将图块发送给光栅化线程池处理
  },
  
  // 4. 合成（Composite）
  composite(rasterizedTiles) {
    // 将所有光栅化后的图块合成为最终帧
    // 发送给 GPU 进程显示
  },
};
```

### 3.3 光栅化线程 (Raster Thread)

**职责：**
- 将图块转换为位图
- GPU 加速光栅化

```javascript
// 光栅化过程
const RasterThread = {
  rasterize(tile) {
    // 将矢量图形转换为位图（像素）
    // 现代浏览器使用 GPU 加速光栅化
    
    // 光栅化后的位图存储在 GPU 内存中
    return bitmap;
  },
};
```

### 3.4 Worker 线程

```javascript
// Web Worker - 独立线程执行 JS
const worker = new Worker('worker.js');

worker.postMessage({ data: 'hello' });

worker.onmessage = (event) => {
  console.log('来自 Worker:', event.data);
};

// worker.js
self.onmessage = (event) => {
  // 执行耗时计算
  const result = heavyComputation(event.data);
  self.postMessage(result);
};
```

```javascript
// Service Worker - 网络代理
navigator.serviceWorker.register('/sw.js').then((registration) => {
  console.log('Service Worker 注册成功');
});

// sw.js
self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request).then((response) => {
      return response || fetch(event.request);
    })
  );
});
```

```javascript
// Shared Worker - 多标签页共享
const sharedWorker = new SharedWorker('shared.js');

sharedWorker.port.postMessage('hello');

sharedWorker.port.onmessage = (event) => {
  console.log('来自 Shared Worker:', event.data);
};
```

## 4. 站点隔离 (Site Isolation)

Chrome 67 引入的安全特性，确保不同站点的内容运行在不同进程中。

```
┌─────────────────────────────────────────────────────────────┐
│                      站点隔离示例                            │
│                                                             │
│  主页面: https://example.com                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    渲染进程 A                        │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │           example.com 的内容                 │   │   │
│  │  │                                             │   │   │
│  │  │   ┌─────────────────────────────────┐      │   │   │
│  │  │   │  <iframe src="other.com">       │      │   │   │
│  │  │   │  ↓ 跨站点，使用不同进程           │      │   │   │
│  │  │   └─────────────────────────────────┘      │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  iframe: https://other.com                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    渲染进程 B                        │   │
│  │  ┌─────────────────────────────────────────────┐   │   │
│  │  │           other.com 的内容                   │   │   │
│  │  └─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**安全优势：**
- 防止 Spectre 等 CPU 漏洞攻击
- 跨站点数据无法被读取
- 恶意网站无法访问其他站点的数据

## 5. 进程间通信 (IPC)

```javascript
// Chrome 使用 Mojo 进行进程间通信
// 简化示意

// 渲染进程请求网络资源
class RendererToNetwork {
  requestResource(url) {
    // 通过 IPC 发送消息给网络进程
    IPC.send('NetworkProcess', {
      type: 'FETCH_RESOURCE',
      payload: { url },
    });
  }
}

// 网络进程响应
class NetworkToRenderer {
  onResourceReady(data) {
    // 通过 IPC 发送响应给渲染进程
    IPC.send('RendererProcess', {
      type: 'RESOURCE_READY',
      payload: { data },
    });
  }
}
```

## 6. 从输入 URL 到页面展示

```
用户输入 URL
     │
     ▼
┌─────────────────┐
│  浏览器主进程    │ ← 1. 处理用户输入，判断是搜索还是 URL
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   网络进程      │ ← 2. DNS 解析、建立连接、发送请求
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  浏览器主进程    │ ← 3. 根据响应类型（Content-Type）决定如何处理
└────────┬────────┘    - text/html → 准备渲染进程
         │             - application/pdf → 下载插件处理
         ▼
┌─────────────────┐
│   渲染进程      │ ← 4. 提交文档，开始解析渲染
└────────┬────────┘
         │
         ▼
    页面显示完成
```

**详细流程：**

```javascript
// 完整的导航流程
async function navigationFlow(url) {
  // 1. 浏览器主进程：处理输入
  const processedUrl = BrowserProcess.processInput(url);
  
  // 2. 网络进程：发起请求
  const response = await NetworkProcess.fetch(processedUrl);
  
  // 3. 浏览器主进程：准备渲染进程
  const rendererProcess = BrowserProcess.prepareRenderer(response);
  
  // 4. 提交导航
  BrowserProcess.commitNavigation(rendererProcess, response);
  
  // 5. 渲染进程：解析和渲染
  await rendererProcess.parseAndRender(response.body);
  
  // 6. 渲染完成，通知浏览器主进程
  rendererProcess.notifyLoadComplete();
}
```

## 7. 查看 Chrome 进程

### 使用 Chrome 任务管理器

```
快捷键：Shift + Esc
或者：菜单 → 更多工具 → 任务管理器
```

### 使用命令行

```bash
# macOS
ps aux | grep Chrome

# Windows
tasklist | findstr chrome

# Linux
ps aux | grep chrome
```

### Chrome 内部页面

```
chrome://process-internals/  # 进程详情
chrome://tracing/            # 性能追踪
chrome://gpu/                # GPU 信息
chrome://memory-internals/   # 内存使用
```

### 示例输出

```
┌──────────────────────────────────────────────────────────────┐
│  Chrome 任务管理器                                            │
├──────────────────────────────────────────────────────────────┤
│  任务                        │ 内存    │ CPU  │ 网络  │ 进程ID │
├──────────────────────────────────────────────────────────────┤
│  浏览器                      │ 150 MB │  2%  │  0   │  1234  │
│  GPU 进程                    │  80 MB │  5%  │  0   │  1235  │
│  网络服务                    │  30 MB │  1%  │ 100K │  1236  │
│  标签页: example.com         │ 100 MB │ 10%  │  50K │  1237  │
│  标签页: google.com          │ 120 MB │  3%  │  20K │  1238  │
│  扩展程序: AdBlock           │  40 MB │  1%  │  0   │  1239  │
│  Service Worker: example.com │  20 MB │  0%  │  0   │  1240  │
└──────────────────────────────────────────────────────────────┘
```

